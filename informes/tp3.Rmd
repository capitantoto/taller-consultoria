---
title: "Taller de Consultoria - TP3"
author: "Gonzalo Barrera Borla"
date: "23/09/2019"
output:
  pdf_document: default
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
options(tinytex.verbose = TRUE)
```

# Setup
```{r}
library(tidyverse) # manipulación de datos en general, graficos
library(broom) # limpieza y estructuracion de resultados de regresiones
```

# Ejercicio 1

>  Los datos siguientes corresponden a un experimento realizado por Charles Darwin en 1876. En cada maceta se plantan dos brotes de maíz, uno producido por fertilización cruzada, y el otro por auto-fertilización. El objetivo era mostrar las ventajas de la fertilización  cruzada. Los datos son las altura finales de las plantas después de un período de tiempo. ¿Alguno de los dos tipos de maíz es demostrablemente mejor?. Si es así, ¿cómo se puede describir la diferencia?. 

Sean $Y_i$ la alturas del brote de maíz producido por fertilización cruzada de la  maceta $i\in\{1,\dots,n\}, n=15$, y $X_i$ la altura del producido por auto-fertilización. Hay dos decisiones preguntas a responder, que determinarán qué clase de test realizar:

a. ¿Es normal la distribución de las alturas de ambos tipos de brotes?
b. ¿Es cada maceta lo suficientemente diferente de las demás para representar un _bloque_ en el diseño del experimento?

Si la respuesta a (a) es "sí", podemos usar un "test t", dSi asumimos que la distribución en la altura de ambas especies es normal, podemos realizar un "test t"


```{r}
tipo_cols <- cols(
  maceta = col_integer(),
  cruz = col_double(),
  auto = col_double()
)
df1 <- read_csv("../data/3-1.csv", col_types = tipo_cols)
df1
wilcox.test(df1$cruz, df1$auto, paired = TRUE, alternative = "greater",
            conf.int = T, conf.level = 0.95)
wilcox.test(df1$cruz, df1$auto, paired = FALSE, alternative = "greater",
            conf.int = T, conf.level = 0.95)
t.test(df1$cruz, df1$auto, paired = TRUE, alternative = "greater",
            conf.int = T, conf.level = 0.95)
t.test(df1$cruz, df1$auto, paired = FALSE, alternative = "greater",
            conf.int = T, conf.level = 0.95, var.equal = FALSE)
t.test(df1$cruz, df1$auto, paired = FALSE, alternative = "greater",
            conf.int = T, conf.level = 0.95, var.equal = TRUE)
```
df %>%
  ggplot(aes(auto, cruz)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1, alpha = 0.3)

df %>%
  gather("tipo", "valor", -maceta) %>%
  ggplot(aes(valor, color = tipo)) +
  geom_density() +
  geom_rug()
juntos <- df %>%
  gather("tipo", "valor", -maceta)
df %>%
  mutate(diferencia = cruz - auto) %>%
  ggplot(aes(diferencia)) +
  geom_density() +
  geom_rug()

# Ejercicio 2
tipo_cols <- cols()
df2 <- read_csv("data/3-2.csv", col_types = tipo_cols)
juntos2 <- df2 %>%
  gather("trt", "sobrevida", -veneno) %>%
  mutate(
#    trt = as_factor(trt),
    sobrevida = sobrevida * 10)
lm2 <- lm(sobrevida ~ veneno + trt, juntos2)
summary(lm2)
anova(lm2)
lm2 <- lm(sobrevida ~ veneno * trt, juntos2)
summary(lm2)
anova(lm2)

juntos2 %>%
  group_by(veneno, trt) %>%
  summarise(s_media = mean(sobrevida)) %>%
  ggplot(aes(trt, s_media, group = veneno, color=veneno)) +
  geom_line()

juntos2 %>%
  group_by(veneno, trt) %>%
  summarise(s_media = mean(sobrevida)) %>%
  ggplot(aes(veneno, s_media, group = trt, color=trt)) +
  geom_line()

TukeyHSD(aov(sobrevida ~ veneno + trt, juntos2))

friedman.test(sobrevida ~ trt | veneno, juntos2)
medias_juntos2 <- juntos2 %>%
  group_by(veneno, trt) %>%
  summarise(sobrevida = mean(sobrevida))
friedman.test(sobrevida ~ trt | veneno, medias_juntos2) %>% str
TukeyHSD(aov(sobrevida ~ veneno + trt, juntos2))
# Ejercicio 3
tipo_cols <- cols(
  substancia = col_factor(),
  dosis = col_double(),
  muestreadas = col_integer(),
  aberrantes = col_integer()
)
df3 <- read_csv("data/3-3.csv", col_types = tipo_cols)

df3 <- df3 %>%
  mutate(
    prop = aberrantes/muestreadas,
    substancia0 = ifelse(dosis==0, "O", levels(substancia)))

lm3a <- lm(prop ~ dosis * substancia, df3)
summary(lm3a)
lm3b <- lm(prop ~ dosis * substancia0, df3)
summary(lm3b)
lm3c <- glm(prop ~ substancia*dosis, df3, weights = muestreadas,
            family=binomial)
summary(lm3c)

lm3d <- glm(aberrantes ~ muestreadas + dosis*substancia, df3, family=binomial)
